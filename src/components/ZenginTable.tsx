import React, { useState, useMemo } from 'react';
import type { ZenginParseResult } from '../hooks/useZenginParser';
import { zenginLayout, type ZenginField, type ParsedRecord } from '../utils/zenginLayout';
import VirtualizedTable from './VirtualizedTable';
import { downloadRecords, downloadAsCSV } from '../utils/fileExport';

interface ZenginTableProps {
  parseResult: ZenginParseResult;
  onClearData: () => void;
  onRecordUpdate: (index: number, updatedRecord: ParsedRecord) => void;
}

const ZenginTable: React.FC<ZenginTableProps> = ({ parseResult, onClearData, onRecordUpdate }) => {
  const [selectedRecordType, setSelectedRecordType] = useState<string>('all');
  const [showErrorsOnly, setShowErrorsOnly] = useState<boolean>(false);
  const [viewMode, setViewMode] = useState<'table' | 'cards' | 'compact' | 'detailed'>('table');
  const [searchTerm, setSearchTerm] = useState<string>('');

  const getRecordTypeDisplay = (recordType: string): string => {
    switch (recordType) {
      case 'header':
        return '„Éò„ÉÉ„ÉÄ„Éº';
      case 'data':
        return '„Éá„Éº„Çø';
      case 'trailer':
        return '„Éà„É¨„Éº„É©„Éº';
      default:
        return '‰∏çÊòé';
    }
  };



  const getRecordTypeIcon = (recordType: string): string => {
    switch (recordType) {
      case 'header': return 'üìã';
      case 'data': return 'üìä';
      case 'trailer': return 'üìÑ';
      default: return '‚ùì';
    }
  };

  const filteredRecords = useMemo(() => {
    let records = parseResult.parsedRecords;
    
    if (selectedRecordType !== 'all') {
      records = records.filter((record: ParsedRecord) => record.recordType === selectedRecordType);
    }
    
    if (showErrorsOnly) {
      records = records.filter((record: ParsedRecord) => !record.validation.isValid);
    }

    if (searchTerm) {
      records = records.filter((record: ParsedRecord) => {
        const searchLower = searchTerm.toLowerCase();
        return (
          record.rawData.toLowerCase().includes(searchLower) ||
          Object.values(record.fields).some(value => 
            value && value.toString().toLowerCase().includes(searchLower)
          ) ||
          record.validation.errors.some(error => 
            error.toLowerCase().includes(searchLower)
          )
        );
      });
    }
    
    return records;
  }, [parseResult.parsedRecords, selectedRecordType, showErrorsOnly, searchTerm]);

  const handleDownload = () => {
    downloadRecords(filteredRecords, 'zengin_edited_data.txt');
  };

  const handleDownloadCSV = () => {
    downloadAsCSV(filteredRecords, 'zengin_data.csv');
  };

  const getFieldLayout = (recordType: string): ZenginField[] => {
    const layout = zenginLayout.find(l => l.recordType === recordType);
    return layout?.fields || [];
  };

  // ÈáçË¶Å„Éï„Ç£„Éº„É´„Éâ„ÇíÁâπÂÆö„Åô„ÇãÈñ¢Êï∞
  const getImportantFields = (recordType: string): string[] => {
    switch (recordType) {
      case 'header':
        return ['dataKubun', 'requestDate', 'clientCode'];
      case 'data':
        return ['bankCode', 'branchCode', 'accountType', 'accountNumber', 'amount', 'recipientName'];
      case 'trailer':
        return ['totalCount', 'totalAmount'];
      default:
        return [];
    }
  };

  const renderRecordCard = (record: ParsedRecord, index: number) => {
    const fields = getFieldLayout(record.recordType);
    const importantFields = getImportantFields(record.recordType);
    const hasErrors = !record.validation.isValid;

    return (
      <div
        key={index}
        className={`zengin-record-card ${hasErrors ? 'error' : ''}`}
      >
        {/* „Ç´„Éº„Éâ„Éò„ÉÉ„ÉÄ„Éº */}
        <div className="zengin-record-header">
          <div className="zengin-record-info">
            <div className="zengin-record-icon">{getRecordTypeIcon(record.recordType)}</div>
            <div>
              <div className="zengin-record-meta">
                <span className={`zengin-record-type ${record.recordType}`}>
                  {getRecordTypeDisplay(record.recordType)}
                </span>
                <span className="zengin-record-line">Ë°å {record.lineNumber}</span>
              </div>
            </div>
          </div>
          
          <div className="zengin-record-status">
            {hasErrors ? (
              <div className="zengin-status-badge error">
                <span className="zengin-icon-md zengin-icon-error"></span>
                <span>„Ç®„É©„Éº</span>
              </div>
            ) : (
              <div className="zengin-status-badge success">
                <span className="zengin-icon-md zengin-icon-success"></span>
                <span>Ê≠£Â∏∏</span>
              </div>
            )}
          </div>
        </div>

        {/* ÈáçË¶Å„Éï„Ç£„Éº„É´„Éâ */}
        {importantFields.length > 0 && (
          <div className="zengin-important-fields">
            <h4>‚≠ê ÈáçË¶ÅÈ†ÖÁõÆ</h4>
            <div className="zengin-fields-grid">
              {importantFields.map(fieldName => {
                const field = fields.find(f => f.name === fieldName);
                if (!field) return null;
                
                const value = record.fields[field.name] || '';
                const hasFieldError = record.validation.errors.some(error => error.includes(field.name));
                
                return (
                  <div key={field.name} className={`zengin-field-item ${hasFieldError ? 'error' : 'normal'}`}>
                    <div className="zengin-field-label">{field.description || field.name}</div>
                    <div className={`zengin-field-value ${hasFieldError ? 'error' : 'normal'}`}>
                      {value || '-'}
                    </div>
                    {hasFieldError && (
                      <div className="zengin-field-error">
                        <span className="zengin-icon-sm zengin-icon-error"></span>
                        „Ç®„É©„Éº„ÅÇ„Çä
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* Ë©≥Á¥∞„Éï„Ç£„Éº„É´„ÉâÔºàÊäò„Çä„Åü„Åü„ÅøÂèØËÉΩÔºâ */}
        {viewMode === 'detailed' && (
          <details className="zengin-details">
            <summary>
              <span className="zengin-icon-md zengin-icon-chevron-right"></span>
              <span>ÂÖ®„Éï„Ç£„Éº„É´„ÉâË©≥Á¥∞</span>
            </summary>
            <div className="zengin-details-content">
              {fields.filter(field => !importantFields.includes(field.name)).map(field => {
                const value = record.fields[field.name] || '';
                const hasFieldError = record.validation.errors.some(error => error.includes(field.name));
                
                return (
                  <div key={field.name} className={`zengin-detail-field ${hasFieldError ? 'error' : 'normal'}`}>
                    <div className="zengin-detail-field-name" title={field.description}>
                      {field.name}
                    </div>
                    <div className={`zengin-detail-field-value ${hasFieldError ? 'error' : 'normal'}`}>
                      {value || '-'}
                    </div>
                    <div className="zengin-detail-field-position">
                      {field.start}-{field.start + field.length - 1}
                    </div>
                  </div>
                );
              })}
            </div>
          </details>
        )}

        {/* „Ç®„É©„ÉºË©≥Á¥∞ */}
        {hasErrors && (
          <div className="zengin-record-errors">
            <h4>üö® „Ç®„É©„ÉºË©≥Á¥∞</h4>
            <ul>
              {record.validation.errors.map((error, errorIndex) => (
                <li key={errorIndex}>{error}</li>
              ))}
            </ul>
          </div>
        )}

        {/* Áîü„Éá„Éº„ÇøÔºà„Ç≥„É≥„Éë„ÇØ„ÉàË°®Á§∫Ôºâ */}
        <div className="zengin-raw-data">
          <div className="zengin-raw-data-label">Áîü„Éá„Éº„Çø</div>
          <div className="zengin-raw-data-content">
            {record.rawData}
          </div>
        </div>
      </div>
    );
  };

  const renderCompactView = () => {
    return (
      <div className="zengin-compact-view">
        {filteredRecords.map((record, index) => (
          <div
            key={index}
            className={`zengin-compact-record ${!record.validation.isValid ? 'error' : ''}`}
          >
            <div className="zengin-compact-left">
              <div className="zengin-compact-icon">{getRecordTypeIcon(record.recordType)}</div>
              <div className="zengin-compact-info">
                <div className="zengin-compact-meta">
                  <span className={`zengin-compact-type ${record.recordType}`}>
                    {getRecordTypeDisplay(record.recordType)}
                  </span>
                  <span className="zengin-compact-line">Ë°å {record.lineNumber}</span>
                </div>
                <div className="zengin-compact-data">
                  {record.rawData}
                </div>
              </div>
            </div>
            
            <div className="zengin-compact-right">
              {!record.validation.isValid ? (
                <div className="zengin-compact-status error">
                  <span className="zengin-icon-md zengin-icon-error"></span>
                  <span className="zengin-compact-status-text">„Ç®„É©„Éº ({record.validation.errors.length})</span>
                </div>
              ) : (
                <div className="zengin-compact-status success">
                  <span className="zengin-icon-md zengin-icon-success"></span>
                  <span className="zengin-compact-status-text">Ê≠£Â∏∏</span>
                </div>
              )}
            </div>
          </div>
        ))}
      </div>
    );
  };

  return (
    <div className="zengin-table">
      <div className="zengin-table-header">
        <div className="zengin-table-title">
          <div className="icon">üìä</div>
          <h2>„Éá„Éº„ÇøËß£ÊûêÁµêÊûú</h2>
        </div>
        <button
          onClick={onClearData}
          className="btn-secondary icon-hover"
        >
          üóëÔ∏è „Éá„Éº„Çø„ÇØ„É™„Ç¢
        </button>
      </div>

      {/* Áµ±Ë®àÊÉÖÂ†± */}
      <div className="zengin-stats-grid">
        <div className="zengin-stat-card">
          <div className="zengin-stat-card-header">
            <h3 className="zengin-stat-card-title">Á∑è„É¨„Ç≥„Éº„ÉâÊï∞</h3>
            <div className="zengin-stat-card-icon">üìä</div>
          </div>
          <div className="zengin-stat-card-value blue">
            {parseResult.totalRecords.toLocaleString()}
          </div>
          <div className="zengin-stat-card-label">ÂÖ®‰Ωì</div>
        </div>
        
        <div className="zengin-stat-card">
          <div className="zengin-stat-card-header">
            <h3 className="zengin-stat-card-title">„Éá„Éº„Çø„É¨„Ç≥„Éº„Éâ</h3>
            <div className="zengin-stat-card-icon">üìà</div>
          </div>
          <div className="zengin-stat-card-value green">
            {parseResult.dataRecords.length.toLocaleString()}
          </div>
          <div className="zengin-stat-card-label">Âá¶ÁêÜÂØæË±°</div>
        </div>
        
        <div className="zengin-stat-card">
          <div className="zengin-stat-card-header">
            <h3 className="zengin-stat-card-title">„Ç®„É©„Éº‰ª∂Êï∞</h3>
            <div className="zengin-stat-card-icon">‚ö†Ô∏è</div>
          </div>
          <div className="zengin-stat-card-value red">
            {parseResult.errorCount.toLocaleString()}
          </div>
          <div className="zengin-stat-card-label">Ë¶Å‰øÆÊ≠£</div>
        </div>
        
        <div className="zengin-stat-card">
          <div className="zengin-stat-card-header">
            <h3 className="zengin-stat-card-title">„Ç®„É©„ÉºÁéá</h3>
            <div className="zengin-stat-card-icon">üìâ</div>
          </div>
          <div className={`zengin-stat-card-value ${
            parseResult.totalRecords > 0 && (parseResult.errorCount / parseResult.totalRecords) > 0.1 
              ? 'red' : 'green'
          }`}>
            {parseResult.totalRecords > 0 
              ? ((parseResult.errorCount / parseResult.totalRecords) * 100).toFixed(1)
              : '0.0'
            }%
          </div>
          <div className="zengin-stat-card-label">ÂìÅË≥™ÊåáÊ®ô</div>
        </div>
      </div>

      {/* „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ */}
      <div className="zengin-control-panel">
        <h3>üéõÔ∏è Ë°®Á§∫Ë®≠ÂÆö</h3>
        
        <div className="zengin-control-grid">
          {/* Ë°®Á§∫„É¢„Éº„Éâ */}
          <div className="zengin-control-group">
            <label>Ë°®Á§∫„É¢„Éº„Éâ</label>
            <select
              value={viewMode}
              onChange={(e) => setViewMode(e.target.value as 'table' | 'cards' | 'compact' | 'detailed')}
              className="zengin-control-select"
            >
              <option value="table">üìã „ÉÜ„Éº„Éñ„É´Ë°®Á§∫ÔºàÁ∑®ÈõÜÂèØËÉΩÔºâ</option>
              <option value="cards">üé¥ „Ç´„Éº„ÉâË°®Á§∫</option>
              <option value="compact">üìã „Ç≥„É≥„Éë„ÇØ„ÉàË°®Á§∫</option>
              <option value="detailed">üìñ Ë©≥Á¥∞Ë°®Á§∫</option>
            </select>
          </div>

          {/* „É¨„Ç≥„Éº„ÉâÁ®ÆÂà• */}
          <div className="zengin-control-group">
            <label>„É¨„Ç≥„Éº„ÉâÁ®ÆÂà•</label>
            <select
              value={selectedRecordType}
              onChange={(e) => setSelectedRecordType(e.target.value)}
              className="zengin-control-select"
            >
              <option value="all">üîç „Åô„Åπ„Å¶Ë°®Á§∫</option>
              <option value="header">üìã „Éò„ÉÉ„ÉÄ„Éº„É¨„Ç≥„Éº„Éâ</option>
              <option value="data">üìä „Éá„Éº„Çø„É¨„Ç≥„Éº„Éâ</option>
              <option value="trailer">üìÑ „Éà„É¨„Éº„É©„Éº„É¨„Ç≥„Éº„Éâ</option>
            </select>
          </div>

          {/* Ê§úÁ¥¢ */}
          <div className="zengin-control-group">
            <label>Ê§úÁ¥¢</label>
            <div className="zengin-search-wrapper">
              <input
                type="text"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                placeholder="„Éá„Éº„Çø„ÇíÊ§úÁ¥¢..."
                className="zengin-control-input search"
              />
              <span className="zengin-icon-md zengin-icon-search"></span>
            </div>
          </div>

          {/* „Ç®„É©„Éº„Éï„Ç£„É´„Çø„Éº */}
          <div className="zengin-control-group">
            <label className="zengin-checkbox-wrapper">
              <input
                type="checkbox"
                checked={showErrorsOnly}
                onChange={(e) => setShowErrorsOnly(e.target.checked)}
                className="zengin-checkbox"
              />
              <span className="zengin-checkbox-label">
                <span>‚ö†Ô∏è</span>
                <span>„Ç®„É©„Éº„ÅÆ„ÅøË°®Á§∫</span>
              </span>
            </label>
          </div>
        </div>

        {/* ÁµêÊûúÊï∞Ë°®Á§∫„Å®„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ */}
        <div className="zengin-result-count">
          <div>
            <span className="zengin-icon-md zengin-icon-chart-bar"></span>
            <span>Ë°®Á§∫‰∏≠: {filteredRecords.length}‰ª∂ / ÂÖ®{parseResult.totalRecords}‰ª∂</span>
          </div>
          <div className="download-buttons">
            <button onClick={handleDownload} className="btn btn-primary btn-sm">
              üì• TXT„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            </button>
            <button onClick={handleDownloadCSV} className="btn btn-secondary btn-sm">
              üìä CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            </button>
          </div>
        </div>
      </div>

      {/* „Ç®„É©„Éº‰∏ÄË¶ß */}
      {parseResult.allErrors.length > 0 && (
        <div className="zengin-error-summary">
          <h3>üö® Ê§úË®º„Ç®„É©„Éº ({parseResult.allErrors.length}‰ª∂)</h3>
          <div className="zengin-error-list">
            <ul>
              {parseResult.allErrors.map((error: string, index: number) => (
                <li key={index}>{error}</li>
              ))}
            </ul>
          </div>
        </div>
      )}

      {/* „Éá„Éº„ÇøË°®Á§∫„Ç®„É™„Ç¢ */}
      <div className="zengin-records-container">
        {filteredRecords.length === 0 ? (
          <div className="zengin-empty-state">
            <span className="zengin-icon-xl zengin-icon-document"></span>
            <div>
              <h3>Ë°®Á§∫„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h3>
              <p>„Éï„Ç£„É´„Çø„ÉºÊù°‰ª∂„ÇíÂ§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>
          </div>
        ) : (
          <>
            {viewMode === 'table' ? (
              <VirtualizedTable
                records={filteredRecords}
                onRecordChange={(filteredIndex, updatedRecord) => {
                  // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åï„Çå„ÅüÈÖçÂàó„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åã„ÇâÂÖÉ„ÅÆÈÖçÂàó„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂèñÂæó
                  const originalIndex = parseResult.parsedRecords.findIndex(
                    record => record.lineNumber === updatedRecord.lineNumber
                  );
                  if (originalIndex !== -1) {
                    onRecordUpdate(originalIndex, updatedRecord);
                  }
                }}
                onDownload={handleDownload}
              />
            ) : viewMode === 'compact' ? (
              renderCompactView()
            ) : (
              <div>
                {filteredRecords.map((record, index) => renderRecordCard(record, index))}
              </div>
            )}
          </>
        )}
      </div>
    </div>
  );
};

export default ZenginTable; 